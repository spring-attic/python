//tag::ref-doc[]
== Python Local Processor
:imagesdir: ../images
:python-springcloudstream: https://pypi.python.org/pypi/springcloudstream


A processor application that starts an external Python process in the local container, sends message payloads to it and
receives the results via a TCP socket. The process must define a function with a single `<str>` or `<bytearray>`
argument that returns a `<str>` or `<bytearray>`.

By default the tcp connection is configured to encode text data delimited with `\r\n` `CRLF`.
However you can set the `tcp.encoder` property to use message length headers, e.g., `L2` to use `pickle`
or `struct` serialization for example. For convenience your Python app should import
the {python-springcloudstream}[springcloudstream>=1.1.0] module to handle the encoding/decoding.

Additionally, the {python-springcloudstream][springcloudstream] module configures a Monitor(ping) Server socket on a
separate port that the Java component uses to monitor the health of the Python process.



[NOTE]
====
If you are running on Cloud Foundry, you need to use the link:../docs/JavaPythonBuildPack.adoc[Java Python buildpack].
Or if deploying as a Docker image, use one of the of the java-python images https://hub.docker.com/u/korekontrol/[here].
====

For local file system scripts (including a Git clone), if `requirements.txt` exists in the base directory,
the application will `pip install` any Python dependencies during start up. If using Conda, the virtual environment must
be configured and active. If the app is running in CloudFoundry, the Java Python buildpack will configure any Python
dependencies.

Here's an example that works with the `time-source` stream app:

=== The Script

time-transformer.py
[source,python]
----
import sys
from datetime import datetime
from springcloudstream.stream import Processor

#06/01/16 09:45:11
def time_delta(data):
	format = '%m/%d/%y %H:%M:%S'
	delta = datetime.now() - datetime.strptime(data,format)
	return str(delta)

#
# The Processor takes a function plus an argument list. For interoperability, the Java application will provide
# the required configuration arguments as command line arguments.
# Options:
#   -h, --help            show this help message and exit
#   -p PORT, --port=PORT  the socket port to use
#   -m MONITOR_PORT, --monitor-port=MONITOR_PORT
#                         the socket to use for the monitoring server
#   -s BUFFER_SIZE, --buffer-size=BUFFER_SIZE
#                         the tcp buffer size
#   -d, --debug           turn on debug logging
#   -c CHAR_ENCODING, --char-encoding=CHAR_ENCODING
#                         character encoding
#   -e ENCODER, --encoder=ENCODER
#                         The name of the encoder to use for delimiting messages
#
process = Processor(time_delta,sys.argv)
process.start(time_delta)
----


Since you are importing `springcloudstream`, you need to provide `requirements.txt` in the top level directory with
an entry for `springcloudstream>=1.1.0` minimally.

=== Jython Wrapper

If you need to do any conversion or transformation, you may optional configure a Jython wrapper.

The Jython wrapper binds the TCP Processor to the `processor` variable as illustrated by this
example:

page_wrapper.py
[source,python]
----
import cPickle as pickle
import json
from java.lang import String

'''
Map to a Python object
'''


class Page:
    def __init__(self, page):
        self.links = {}
        for key in page.links:
            self.links[key] = page.links[key].toString()
        self.images = {}
        for key in page.images:
            self.images[key] = page.images[key]

protocol = 1

'payload is bound to Java object spring.io.data.Page'
page = Page(payload)

'Pickle the Page dict representation'
input = pickle.dumps(page.__dict__, protocol)
'processor is bound to TcpProcessor. Invoke the processor and receive a dict'
print(processor.getClass().getName())
data = processor.sendAndReceive(input)
'deserialize'
returned_page = pickle.loads(data)
'transform to java String as Json'
result = String(json.dumps(returned_page))
----

[NOTE]
----
The last line in the script must be an assignment statement. The variable name doesn't matter. This is required to bind the return value correctly.
----


Page.java
[source, java]
----
public class Page {
	private Map<String, Object> links = new HashMap<>();
	private Map<String,Object> images = new HashMap<>();

	public Map<String, Object> getLinks() {
		return links;
	}

	public void setLinks(Map<String, Object> links) {
		this.links = links;
	}

	public Map<String, Object> getImages() {
		return images;
	}

	public void setImages(Map<String, Object> images) {
		this.images = images;
	}
}

----

pickle_page_example.py
[source,python]
----
import cPickle as pickle
import sys
from springcloudstream.stream import Processor

class Page:
    def __init__(self, data):
        self.links = data['links']
        self.images = data['images']


protocol = 1

def unpickle(bytes):
    data = str(bytes)
    try:
        data = pickle.loads(data)
        return pickle.dumps(Page(data).__dict__, protocol)
    except:
        return "unpickle failed [%s] [%s] [%s]" % (sys.exc_info()[0], sys.exc_info()[1], sys.exc_info()[2])

sys.argv.extend(['--debug','True'])
Processor(unpickle, sys.argv).start()
----

TThe `page_wrapper.py` Jython wrapper transforms the input prior to invoking the Python app via `processor
.sendAndReceive()`. This is the Java `TcpProcessor` that calls the `pickle_page_example.py` in this case. It is always
bound to the variable named `processor`. The wrapper script subsequently transforms the result to a JSON string,
which will be consumed by the next app in the stream.

See link:../docs/JavaPythonBuildPack.adoc[Deploying to Cloud Foundry]

{nbsp}

image:python-local-procesor.gif[LocalProcessor]

== Options

The **$$python-local$$** $$processor$$ has the following options:



//tag::configuration-properties[]
$$git.basedir$$:: $$The base directory where the repository should be cloned. If not specified, a temporary directory will be
 created.$$ *($$File$$, default: `$$<none>$$`)*
$$git.clone-on-start$$:: $$Flag to indicate that the repository should be cloned on startup (not on demand).
 Generally leads to slower startup but faster first query.$$ *($$Boolean$$, default: `$$true$$`)*
$$git.label$$:: $$The label or branch to clone.$$ *($$String$$, default: `$$master$$`)*
$$git.passphrase$$:: $$The passphrase for the remote repository.$$ *($$String$$, default: `$$<none>$$`)*
$$git.password$$:: $$The password for the remote repository.$$ *($$String$$, default: `$$<none>$$`)*
$$git.timeout$$:: $$Timeout (in seconds) for obtaining HTTP or SSH connection (if applicable). Default
 5 seconds.$$ *($$Integer$$, default: `$$5$$`)*
$$git.uri$$:: $$The URI of the remote repository.$$ *($$String$$, default: `$$<none>$$`)*
$$git.username$$:: $$The username for the remote repository.$$ *($$String$$, default: `$$<none>$$`)*
$$python.args$$:: $$The Python command line args.$$ *($$String$$, default: `$$<empty string>$$`)*
$$python.basedir$$:: $$The root path of Python app. If given, the script path must be relative to this location.$$ *($$FileSystemResource$$, default: `$$<none>$$`)*
$$python.command-name$$:: $$The python command name, e.g., 'python', 'python3'.$$ *($$String$$, default: `$$python$$`)*
$$python.pip-command-name$$:: $$The pip command name, e.g., 'pip', 'pip3'.$$ *($$String$$, default: `$$pip$$`)*
$$python.script$$:: $$The Python script file name.$$ *($$String$$, default: `$$<none>$$`)*
$$tcp.buffer-size$$:: $$The buffer size used when decoding messages; larger messages will be rejected.$$ *($$Integer$$, default: `$$2048$$`)*
$$tcp.charset$$:: $$The charset used when converting from bytes to String.$$ *($$String$$, default: `$$UTF-8$$`)*
$$tcp.encoder$$:: $$The encoder to use when sending messages.$$ *($$Encoding$$, default: `$$<none>$$`, possible values: `CRLF`,`LF`,`STXETX`,`L1`,`L2`,`L4`)*
$$tcp.nio$$:: $$<documentation missing>$$ *($$Boolean$$, default: `$$<none>$$`)*
$$tcp.retry-interval$$:: $$Retry interval (in milliseconds) to check the connection and reconnect.$$ *($$Long$$, default: `$$60000$$`)*
$$tcp.socket-timeout$$:: $$<documentation missing>$$ *($$Integer$$, default: `$$<none>$$`)*
$$tcp.use-direct-buffers$$:: $$<documentation missing>$$ *($$Boolean$$, default: `$$<none>$$`)*
//end::configuration-properties[]

$$python.contentType$$:: $$The output contentType, e.g., application/json.$$ *($$String$$, default: `$$<none>$$`)*

== Build

[source, bash]
----
$./mvnw package
----
//end::ref-doc[]
